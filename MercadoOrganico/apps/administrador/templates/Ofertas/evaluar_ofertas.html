<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Evaluar Ofertas</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.1/bootstrap-table.min.css">
    <script src="//code.jquery.com/jquery.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.1/bootstrap-table.min.js"></script>
    <script>
        function evaluar(ofertaId,estadoId,productoId)
        {
            $.ajax({
               type: "POST",
               url: "http://127.0.0.1:8000/catalogo/guardarOferta/",
               data: JSON.stringify({ ofertaId: ofertaId, estadoId : estadoId}),
               contentType: "application/json; charset=utf-8",
               dataType: "json",
               success: function (data) {
                   alert(ofertaId);
                   $("#select_productos").val(productoId);
                   $("#select_productos").change();
               },
               failure: function(errMsg){
                   alert("Hubo un error");
               }
            });
        };

        $(document).ready(function () {
            //Mostrar listado de ofertas
            var productos = $("#select_productos");
            $(productos).change(function () {
                $("#lista_ofertas_producto").find("tr:gt(0)").remove();
                var selected_producto = productos.val();
                if(selected_producto == ''){
                    selected_producto = 0
                }
                $.getJSON("http://127.0.0.1:8000/catalogo/listarOfertas/" + selected_producto).done(function (data) {
                    var items = [];
                    $.each(data, function (key,val) {
                        items.push("<tr>");
                        items.push("<td id=''"+key+"''>"+val.fecha+"</td>");
                        items.push("<td id=''"+key+"''>"+val.productor+"</td>");
                        items.push("<td id=''"+key+"''>"+val.precio+"</td>");
                        items.push("<td id=''"+key+"''>"+val.unidad+"</td>");
                        items.push("<td id=''"+key+"''>"+val.cantidad+"</td>");
                        if (val.estadoId == '1'){
                            items.push("<td class='nuevo'><input type=\"button\" id=\"Aprobar\" value=\"Aprobar\" onclick=\"evaluar("+val.id+","+2+","+selected_producto+")\"/>" +
                                                         "<input type=\"button\" id=\"Rechazar\" value=\"Rechazar\" onclick=\"evaluar("+val.id+","+3+","+selected_producto+")\"/></td>");
                        }
                        else{
                             items.push("<td id=''"+key+"''>"+val.estadoNombre+"</td>");
                        }
                        items.push("</tr>");
                    });
                    $("<tbody/>",{html: items.join("")}).appendTo("table");
                });
            });

            //Listar productos
            $.getJSON("http://127.0.0.1:8000/catalogo/seleccionarProductos/").done(function (data) {
                 var options = $("#select_productos");
                 options.append($("<option />").val('').text('Seleccione producto'));
                 $.each(data, function() {
                    options.append($("<option />").val(this.id).text(this.nombre));
                });
            });
        });
    </script>
</head>
<body>
    <div class="col-md-4 col-md-offset-4">
                <label for="select_productos" class="label-control">Producto:</label>
                <select id="select_productos" class="form-control" style="margin-bottom: 20px"></select>
    </div>
    <div class="container">
        <table id="lista_ofertas_producto"
               class="table table-responsive">
         <thead>
             <tr>
                 <th class="col-xs-1">Fecha de la oferta</th>
                 <th class="col-xs-1">Productor</th>
                 <th class="col-xs-1">Precio (Unidad)</th>
                 <th class="col-xs-1">Unidad</th>
                 <th class="col-xs-1">Cantidad Disponible</th>
                 <th class="col-xs-1">Estado</th>
             </tr>
         </thead>
        </table>
        <!--<input id="submit1" type="button" value="Submit"/>-->
    </div>
</body>
</html>